package exploit

import (
	"github.com/stretchr/testify/assert"
	"io/ioutil"
	"os"
	"regexp"
	"testing"
)

func captureStdout(f func()) string {
	rescueStdout := os.Stdout
	r, w, _ := os.Pipe()
	os.Stdout = w
	f()
	_ = w.Close()
	out, _ := ioutil.ReadAll(r)
	os.Stdout = rescueStdout
	return string(out)
}

func TestSearchLocalFileText(t *testing.T) {
	expectedStdout := `
found RSA private key in: ../../test/scan_file_text/1
[-----BEGIN RSA PRIVATE KEY-----]

found RSA private key in: ../../test/scan_file_text/xxx/2.txt
[-----BEGIN RSA PRIVATE KEY-----]

found Twilio API Key in: ../../test/scan_file_text/xxx/2.txt
[SKaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa]

found AWS API Key in: ../../test/scan_file_text/xxx/2.txt
[AKIA99999999999999AB]
`

	actualStdout := captureStdout(func() {
		SearchLocalFileText("../../test")
	})

	pattern := regexp.MustCompile("found ")
	expParams := len(pattern.FindAllStringSubmatch(string(expectedStdout), -1))
	actParams := len(pattern.FindAllStringSubmatch(string(actualStdout), -1))

	assert.Equal(t, expParams, actParams, "That should be equal")
}
